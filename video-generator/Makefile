# å‹•ç”»ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ - Makefile
.PHONY: help install dev run test lint check docker-build docker-up docker-down clean

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "ğŸ¬ å‹•ç”»ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ - åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰"
	@echo ""
	@echo "ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:"
	@echo "  make install     - ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo "  make dev         - é–‹ç™ºç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
	@echo ""
	@echo "å®Ÿè¡Œ:"
	@echo "  make run         - ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•"
	@echo "  make docker-up   - Dockerã§èµ·å‹•"
	@echo "  make docker-dev  - Dockeré–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•"
	@echo ""
	@echo "ãƒ†ã‚¹ãƒˆãƒ»å“è³ª:"
	@echo "  make test        - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
	@echo "  make lint        - Lintãƒã‚§ãƒƒã‚¯"
	@echo "  make check       - ç’°å¢ƒãƒã‚§ãƒƒã‚¯"
	@echo ""
	@echo "Docker:"
	@echo "  make docker-build - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make docker-down  - Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢"
	@echo ""
	@echo "ãã®ä»–:"
	@echo "  make clean       - ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤"

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
install:
	pip install -r requirements.txt

# é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
dev:
	python -m venv venv
	. venv/bin/activate && pip install -r requirements.txt
	mkdir -p output temp
	@echo ""
	@echo "âœ… é–‹ç™ºç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ"
	@echo "   source venv/bin/activate ã§ä»®æƒ³ç’°å¢ƒã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„"

# ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ
run:
	@chmod +x scripts/start.sh
	./scripts/start.sh local

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
test:
	pytest tests/ -v

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆ
test-cov:
	pytest tests/ --cov=src --cov-report=html --cov-report=term

# Lintãƒã‚§ãƒƒã‚¯
lint:
	ruff check src/
	ruff check tests/

# Lintè‡ªå‹•ä¿®æ­£
lint-fix:
	ruff check src/ --fix
	ruff check tests/ --fix

# å‹ãƒã‚§ãƒƒã‚¯
typecheck:
	mypy src/

# ç’°å¢ƒãƒã‚§ãƒƒã‚¯
check:
	python scripts/check_env.py

# Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
docker-build:
	docker-compose build

# Dockerèµ·å‹•
docker-up:
	docker-compose up -d
	@echo ""
	@echo "âœ… Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã—ãŸ"
	@echo "   URL: http://localhost:8502"
	@echo "   ãƒ­ã‚°: make docker-logs"

# Dockeré–‹ç™ºãƒ¢ãƒ¼ãƒ‰
docker-dev:
	docker-compose --profile dev up app-dev

# Dockerãƒ­ã‚°
docker-logs:
	docker-compose logs -f

# Dockeråœæ­¢
docker-down:
	docker-compose down

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean:
	rm -rf __pycache__ .pytest_cache .coverage htmlcov
	rm -rf src/__pycache__ src/**/__pycache__
	rm -rf tests/__pycache__
	rm -rf temp/*
	rm -rf .mypy_cache .ruff_cache
	@echo "âœ… ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"

# å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean-output:
	rm -rf output/*
	@echo "âœ… å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"

# å…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean-all: clean clean-output
	rm -rf venv
	@echo "âœ… å…¨ã¦ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ"
