# 動画生成エージェント - 要件定義書

## 要件定義の作成原則
- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

---

## 1. プロジェクト概要

### 1.1 成果目標
Word/テキスト台本（speaker1/speaker2形式）＋画像プロンプト（タイミング指定付き）を入力し、Google Cloud TTSで音声化、Gemini 3 Pro Image（ナノバナナプロ）で紙芝居画像生成、Beatoven.aiでBGM作成、Pexels/Pixabayから動画素材取得し、**Filmoraハイブリッドモード**または**AI完全オートモード**を選択してYouTube/Instagram/TikTok用動画を出力するアプリケーション。

### 1.2 成功指標

#### 定量的指標
- 10分程度の台本から完成動画の生成が60分以内（オートモード）
- YouTube/Instagram/TikTok用の3種類のフォーマットを自動出力
- 音声と映像の同期ズレが0.5秒以内
- 各セリフに対応した画像を正確に生成・配置
- 2人の話者（speaker1/speaker2）の音声を区別して生成

#### 定性的指標
- 台本＋プロンプトをアップロードするだけで動画完成
- 生成された音声が自然で聞き取りやすい
- 紙芝居形式の画像切り替えがスムーズ
- 指定タイミングでの画像切り替えが正確
- ハイブリッド/オートの選択で柔軟な運用が可能

---

## 2. システム全体像

### 2.1 主要機能一覧
- **台本解析**: Word/テキストファイルからspeaker1/speaker2形式の台本を解析
- **音声生成**: Google Cloud TTSで各話者の音声を生成
- **音声チェック**: 情景補足の自動除去、読み仮名指定、プレビュー再生
- **画像生成**: Gemini 3 Pro Imageで紙芝居用画像を生成
- **BGM生成**: Beatoven.aiでバックグラウンド音楽を生成
- **動画素材取得**: Pexels/Pixabay APIで動画素材を取得
- **動画編集**: MoviePy/FFmpegで自動編集、またはFilmora用素材出力

### 2.2 ユーザーロールと権限（MVP - 認証なし）
- 個人利用ツールのため、認証・権限管理は不要

### 2.3 2つの出力モード

| 項目 | Filmoraモード | 自動モード |
|------|--------------|-----------|
| 音声ファイル | 出力 | （内部処理） |
| 画像ファイル | 出力 | （内部処理） |
| BGMファイル | 出力 | （内部処理） |
| 動画素材 | 出力 | （内部処理） |
| タイムライン情報 | CSV/JSON出力 | （内部処理） |
| **完成動画** | なし（手動編集） | YouTube/Instagram/TikTok用 |

---

## 3. ページ詳細仕様

### 3.1 P-001: 動画生成メイン

#### 目的
台本と画像プロンプトから動画を一括生成する。全ての生成処理を1画面で完結させ、最小の操作で動画出力を実現。

#### 処理フロー

```
STEP 1: ファイルアップロード
  ├─ 台本ファイル（Word/テキスト）
  └─ 画像プロンプトファイル（Word/テキスト）
        ↓
STEP 2: 台本プレビュー＆前処理
  ├─ 情景補足（カッコ内）を自動検出・除去
  ├─ 除去された箇所をハイライト表示
  └─ 読み仮名指定（例: {生物|せいぶつ}）
        ↓
STEP 3: 音声プレビュー＆確認
  ├─ セリフごとに音声を生成＆再生ボタン
  ├─ 問題があれば読み仮名を修正して再生成
  └─ 全セリフOKなら「確定」ボタンで次へ
        ↓
STEP 4: モード選択＆生成実行
  ├─ Filmoraモード / 自動モード選択
  ├─ 出力形式選択（自動モード時・複数選択可）
  │   ├─ YouTube (1920×1080, 16:9)
  │   ├─ Instagram リール (1080×1920, 9:16)
  │   ├─ Instagram フィード (1080×1080, 1:1)
  │   ├─ TikTok (1080×1920, 9:16)
  │   └─ カスタム (任意解像度)
  └─ 生成実行
        ↓
STEP 5: 結果ダウンロード
  ├─ Filmoraモード: 素材一式＋タイムラインCSV
  └─ 自動モード: 完成動画ファイル
```

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| アップロード | 台本ファイル取込 | Word/テキストファイル | パース済み台本データ |
| アップロード | 画像プロンプト取込 | Word/テキストファイル | タイミング付きプロンプト一覧 |
| 前処理 | 情景補足除去 | パース済み台本 | クリーンな台本＋除去ログ |
| 生成 | 音声プレビュー | セリフテキスト | MP3音声ファイル |
| 生成 | 画像生成 | プロンプト | PNG画像ファイル |
| 生成 | BGM生成 | ムード/ジャンル指定 | MP3音楽ファイル |
| 取得 | 動画素材取得 | キーワード | MP4動画ファイル |
| 編集 | 動画合成 | 全素材 | 完成動画/素材一式 |

#### データ構造（概念）

```yaml
台本データ:
  識別子: ファイル名
  セリフ一覧:
    - 番号（必須）
    - 話者（speaker1/speaker2）（必須）
    - テキスト（必須）
    - 情景補足（自動除去対象）（任意）
    - 読み仮名指定（任意）
  メタ情報:
    - 総セリフ数
    - 推定再生時間

画像プロンプトデータ:
  識別子: ファイル名
  プロンプト一覧:
    - 番号（必須）
    - 開始時間（必須）
    - 終了時間（必須）
    - プロンプトテキスト（必須）
  メタ情報:
    - 総画像数
```

---

### 3.2 P-002: 設定ページ

#### 目的
話者・APIキー・デフォルト設定を管理する。事前設定により毎回の入力を省略し、効率的な運用を実現。

#### 主要機能

**話者設定（speaker1/speaker2）:**
- 表示名
- Google TTS音声選択（ja-JP-Neural2-B等）
- アバター画像アップロード（オプション）

**APIキー設定:**
- Google Cloud APIキー
- Beatoven.ai APIキー
- Pexels APIキー
- Pixabay APIキー

**デフォルト設定:**
- デフォルト出力形式（YouTube/Instagram/TikTok）
- BGMのムード/ジャンル
- 出力フォルダパス

#### データ構造（概念）

```yaml
設定データ:
  話者設定:
    speaker1:
      - 表示名
      - TTS音声ID
      - アバター画像パス
    speaker2:
      - 表示名
      - TTS音声ID
      - アバター画像パス
  APIキー:
    - google_cloud_api_key
    - beatoven_api_key
    - pexels_api_key
    - pixabay_api_key
  デフォルト設定:
    - default_output_format
    - bgm_mood
    - output_folder
```

---

## 4. データ設計概要

### 4.1 主要エンティティ

```yaml
台本（Script）:
  概要: アップロードされた台本ファイルのパース結果
  主要属性:
    - ファイル情報（名前、形式、サイズ）
    - セリフ一覧
    - メタ情報（総セリフ数、推定時間）
  関連:
    - 音声ファイル（1対多）

画像プロンプト（ImagePrompt）:
  概要: 画像生成用のプロンプトとタイミング情報
  主要属性:
    - プロンプト一覧
    - タイミング情報
  関連:
    - 生成画像（1対多）

生成物（Output）:
  概要: 生成された各種ファイル
  主要属性:
    - 音声ファイル群
    - 画像ファイル群
    - BGMファイル
    - 動画素材群
    - 完成動画（オートモード時）
    - タイムラインCSV（Filmoraモード時）
```

### 4.2 エンティティ関係図

```
台本 ─── 1:多 ─── セリフ ─── 1:1 ─── 音声ファイル
                    │
画像プロンプト ─── 1:多 ─── プロンプト ─── 1:1 ─── 画像ファイル
                    │
設定 ─── 1:1 ─── 話者設定
     ─── 1:1 ─── APIキー設定
     ─── 1:1 ─── デフォルト設定
```

### 4.3 入力ファイルフォーマット

#### 台本ファイル形式
```
speaker1: こんにちは、今日は不動産投資について解説します。
speaker2: (ため息をついて) よろしくお願いします！
speaker1: まず{DSCR|ディーエスシーアール}について説明します。
```

#### 画像プロンプトファイル形式
```
[1] 0:00-0:15 | スタジオ風の背景、2人のキャスターが座っている
[2] 0:15-0:30 | 驚いた表情の女性キャラクター
[3] 0:30-1:00 | 高層マンションと赤い下矢印グラフ
```

---

## 5. 制約事項

### 外部API制限

| サービス | 制限内容 |
|----------|---------|
| Google Cloud TTS | 無料枠400万文字/月、1リクエスト5,000バイト |
| Gemini 3 Pro Image | 従量課金（1枚約21円〜）、1日1,500枚まで（開発環境） |
| Beatoven.ai | プランに応じたクレジット制限 |
| Pexels | 200リクエスト/時間、20,000リクエスト/月 |
| Pixabay | 100リクエスト/60秒 |

### 技術的制約
- **ファイルサイズ**: アップロード可能な台本ファイルは10MB以下
- **動画長**: 自動モードでの出力動画は最大30分
- **画像枚数**: 1動画あたり最大100枚
- **同時処理**: 1動画ずつ処理（並列処理なし）

---

## 5.1 セキュリティ要件

### 基本方針
個人利用ツールのため、最小限のセキュリティ要件とする。

### 必須要件
- APIキーは.envファイルで管理（Git管理外）
- 出力ファイルはローカルファイルシステムに保存
- 外部送信するデータは各APIへのリクエストのみ

### 運用要件
- ローカル実行のため、ヘルスチェック・グレースフルシャットダウンは不要

---

## 6. 複合API処理（バックエンド内部処理）

### 複合処理-001: 動画生成（オートモード）

**トリガー**: 「生成実行」ボタンクリック（オートモード選択時）

**処理フロー**:
1. 台本パース - 情景補足除去、読み仮名展開
2. Google Cloud TTS - 各セリフの音声生成
3. Gemini 3 Pro Image - 各プロンプトの画像生成
4. Beatoven.ai - BGM生成
5. Pexels/Pixabay - 動画素材取得（キーワード検索）
6. MoviePy/FFmpeg - 全素材を合成、動画出力

**結果**: YouTube/Instagram/TikTok用動画ファイル

**外部サービス依存**: Google Cloud TTS, Gemini API, Beatoven.ai, Pexels, Pixabay

---

### 複合処理-002: 素材生成（Filmoraモード）

**トリガー**: 「生成実行」ボタンクリック（Filmoraモード選択時）

**処理フロー**:
1. 台本パース - 情景補足除去、読み仮名展開
2. Google Cloud TTS - 各セリフの音声生成
3. Gemini 3 Pro Image - 各プロンプトの画像生成
4. Beatoven.ai - BGM生成
5. Pexels/Pixabay - 動画素材取得
6. タイムラインCSV生成 - 各素材の配置情報

**結果**:
```
output/
├── audio/
│   ├── 001_speaker1.mp3
│   ├── 002_speaker2.mp3
│   └── ...
├── images/
│   ├── 001_scene.png
│   ├── 002_scene.png
│   └── ...
├── bgm/
│   └── background_music.mp3
├── videos/
│   ├── stock_001.mp4
│   └── ...
└── timeline.csv
```

**外部サービス依存**: Google Cloud TTS, Gemini API, Beatoven.ai, Pexels, Pixabay

---

## 7. 技術スタック

```yaml
フレームワーク: Streamlit
言語: Python 3.11+

主要ライブラリ:
  UI: streamlit
  音声生成: google-cloud-texttospeech
  画像生成: google-genai
  BGM生成: beatoven (公式SDK)
  動画素材: requests (Pexels/Pixabay API)
  動画編集: moviepy, ffmpeg-python
  Wordファイル: python-docx
  設定管理: python-dotenv

データ保存:
  設定ファイル: JSON（ローカル）
  APIキー: .env ファイル
  出力先: output/ フォルダ

実行環境: ローカルPC
```

---

## 8. 必要な外部サービス・アカウント

### 必須サービス

| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| Google Cloud | TTS音声生成 + Gemini画像生成 | https://console.cloud.google.com/ | 無料枠あり |
| Beatoven.ai | BGM生成 | https://www.beatoven.ai/ | $2.5/月〜 |
| Pexels | 動画素材取得 | https://www.pexels.com/api/ | 無料 |
| Pixabay | 動画素材取得（予備） | https://pixabay.com/api/docs/ | 無料 |

### オプションサービス

| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| Filmora | 動画編集（ハイブリッドモード） | https://filmora.wondershare.jp/ | 別途購入が必要 |

---

## 9. 今後の拡張予定

**原則**: 拡張予定があっても、必要最小限の実装のみを行う

拡張が必要になった時点で、Phase 11: 機能拡張オーケストレーターを使用して追加実装を行います。

（拡張候補）
- 3人以上の話者対応
- 字幕（テロップ）自動生成
- サムネイル自動生成
- 動画テンプレート機能
- バッチ処理（複数動画一括生成）
